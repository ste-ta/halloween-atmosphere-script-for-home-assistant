alias: ðŸŽ„ðŸŽƒ ðŸŽ† Holiday Atmosphere (v2)
description: >-
  Creates various festive lighting effects for holidays (optimized for older
  bulbs, uses XY color space for better Zigbee compatibility). v2 - adds
  Christmas and New Year's effects.
mode: restart
max_exceeded: silent
fields:
  lights:
    description: List of light entity IDs
    example: light.living_room, light.hallway, light.kitchen
    selector:
      entity:
        multiple: true
        domain: light
  effect:
    description: Which effect to play
    example: hell
    selector:
      select:
        options:
          - hell
          - lightning
          - graveyard
          - halloween
          - blood
          - stop
          - xmas_twinkle
          - xmas_tree
          - xmas_snowfall
          - xmas_candlelight
          - xmas_gift_pulse
          - nye_countdown
          - nye_confetti
          - nye_midnight_flash
          - nye_sparkler
          - nye_champagne
variables:
  lights_list: |
    {{ lights if lights is iterable and lights is not string else [lights] }}
  scene_backup_id: holiday_script_backup
sequence:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effect != 'stop' }}"
        sequence:
          - data:
              scene_id: "{{ scene_backup_id }}"
              snapshot_entities: "{{ lights_list }}"
            continue_on_error: true
            action: scene.create
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effect == 'stop' }}"
        sequence:
          - target:
              entity_id: scene.{{ scene_backup_id }}
            data:
              transition: 1
            continue_on_error: true
            action: scene.turn_on
          - delay:
              milliseconds: 1000
          - continue_on_error: true
            action: scene.delete
            target:
              entity_id: scene.{{ scene_backup_id }}
          - stop: Halloween effect stopped
      - conditions:
          - condition: template
            value_template: "{{ effect == 'hell' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 200
                    xy_color:
                      - 0.6736
                      - 0.3221
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 100
          - delay:
              milliseconds: 1000
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          colors:
                            - - 0.7006
                              - 0.2993
                            - - 0.6736
                              - 0.3221
                            - - 0.6389
                              - 0.3548
                            - - 0.675
                              - 0.322
                          brightness_levels:
                            - 255
                            - 200
                            - 150
                            - 100
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color: "{{ colors | random }}"
                          brightness: "{{ brightness_levels | random }}"
                          transition: "{{ range(2, 4) | random }}"
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: 150
                - delay:
                    seconds: "{{ range(4, 7) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'lightning' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 5
                    xy_color:
                      - 0.3127
                      - 0.329
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 100
          - delay:
              milliseconds: 1000
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - variables:
                    lightning_wait_time: "{{ range(2, 4) | random }}"
                    lightning_count: "{{ range(4, 10) | random }}"
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          brightness: "{{ range(2, 10) | random }}"
                          xy_color:
                            - 0.3127
                            - 0.329
                          transition: 1
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: 50
                - delay:
                    seconds: "{{ lightning_wait_time }}"
                - repeat:
                    count: "{{ lightning_count }}"
                    sequence:
                      - repeat:
                          for_each: "{{ lights_list }}"
                          sequence:
                            - target:
                                entity_id: "{{ repeat.item }}"
                              data:
                                brightness: 255
                                xy_color:
                                  - 0.3227
                                  - 0.329
                                transition: 0
                              continue_on_error: true
                              action: light.turn_on
                            - delay:
                                milliseconds: 50
                      - delay:
                          milliseconds: "{{ range(20, 200) | random }}"
                      - repeat:
                          for_each: "{{ lights_list }}"
                          sequence:
                            - target:
                                entity_id: "{{ repeat.item }}"
                              data:
                                brightness: "{{ range(3, 10) | random }}"
                                xy_color:
                                  - 0.3127
                                  - 0.329
                                transition: 0
                              continue_on_error: true
                              action: light.turn_on
                            - delay:
                                milliseconds: 100
                      - delay:
                          milliseconds: "{{ range(200, 600) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'graveyard' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 40
                    xy_color:
                      - 0.2039
                      - 0.4443
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 100
          - delay:
              milliseconds: 1000
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          colors:
                            - - 0.1724
                              - 0.6531
                            - - 0.2039
                              - 0.4443
                            - - 0.1607
                              - 0.2218
                            - - 0.2182
                              - 0.6225
                            - - 0.1649
                              - 0.5703
                            - - 0.2127
                              - 0.3608
                            - - 0.1532
                              - 0.2947
                            - - 0.194
                              - 0.4953
                            - - 0.1781
                              - 0.2843
                            - - 0.2458
                              - 0.5841
                          brightness_levels:
                            - 40
                            - 50
                            - 30
                            - 60
                            - 35
                            - 45
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color: "{{ colors | random }}"
                          brightness: "{{ brightness_levels | random }}"
                          transition: "{{ range(5, 10) | random }}"
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: 200
                - delay:
                    seconds: "{{ range(6, 14) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'halloween' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 200
                    xy_color:
                      - 0.6389
                      - 0.3548
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 100
          - delay:
              milliseconds: 1000
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          colors:
                            - - 0.6389
                              - 0.3548
                            - - 0.3645
                              - 0.1765
                            - - 0.3833
                              - 0.1591
                            - - 0.5801
                              - 0.3959
                            - - 0.2138
                              - 0.7097
                            - - 0.2679
                              - 0.6616
                          brightness_levels:
                            - 200
                            - 180
                            - 150
                            - 220
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color: "{{ colors | random }}"
                          brightness: "{{ brightness_levels | random }}"
                          transition: "{{ range(3, 6) | random }}"
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: 150
                - delay:
                    seconds: "{{ range(4, 9) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'blood' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 10
                    xy_color:
                      - 0.675
                      - 0.322
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 100
          - delay:
              milliseconds: 1000
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          colors:
                            - - 0.675
                              - 0.322
                            - - 0.7006
                              - 0.2993
                            - - 0.685
                              - 0.3088
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color: "{{ colors | random }}"
                          brightness: "{{ range(150, 200) | random }}"
                          transition: 0.3
                        continue_on_error: true
                        action: light.turn_on
                - delay:
                    milliseconds: 200
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          brightness: "{{ range(20, 40) | random }}"
                          transition: 0.4
                        continue_on_error: true
                        action: light.turn_on
                - delay:
                    milliseconds: 150
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          brightness: "{{ range(120, 160) | random }}"
                          transition: 0.3
                        continue_on_error: true
                        action: light.turn_on
                - delay:
                    milliseconds: 200
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          brightness: "{{ range(5, 15) | random }}"
                          transition: 0.8
                        continue_on_error: true
                        action: light.turn_on
                - delay:
                    seconds: "{{ range(2, 4) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'xmas_twinkle' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: "{{ range(50, 180) | random }}"
                    xy_color:
                      - 0.3227
                      - 0.329
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 120
          - delay:
              milliseconds: 800
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          base_xy:
                            - 0.3227
                            - 0.329
                          x_jitter: "{{ (range(-8,9) | random) / 1000 }}"
                          y_jitter: "{{ (range(-8,9) | random) / 1000 }}"
                          chosen_x: "{{ (base_xy[0] + x_jitter) | round(4) }}"
                          chosen_y: "{{ (base_xy[1] + y_jitter) | round(4) }}"
                          bright: "{{ range(30, 200) | random }}"
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color:
                            - "{{ chosen_x }}"
                            - "{{ chosen_y }}"
                          brightness: "{{ bright }}"
                          transition: "{{ range(1,3) | random }}"
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: "{{ range(150, 450) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'xmas_tree' }}"
        sequence:
          - variables:
              tree_colors:
                - - 0.2138
                  - 0.7097
                - - 0.6389
                  - 0.3548
                - - 0.3227
                  - 0.329
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          base_xy: "{{ tree_colors | random }}"
                          x_jitter: "{{ (range(-12,13) | random) / 1000 }}"
                          y_jitter: "{{ (range(-12,13) | random) / 1000 }}"
                          chosen_x: "{{ (base_xy[0] + x_jitter) | round(4) }}"
                          chosen_y: "{{ (base_xy[1] + y_jitter) | round(4) }}"
                          bright: "{{ range(120, 255) | random }}"
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color:
                            - "{{ chosen_x }}"
                            - "{{ chosen_y }}"
                          brightness: "{{ bright }}"
                          transition: 0.5
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: 120
      - conditions:
          - condition: template
            value_template: "{{ effect == 'xmas_snowfall' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 30
                    xy_color:
                      - 0.1532
                      - 0.2947
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 100
          - delay:
              milliseconds: 900
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          blues:
                            - - 0.1532
                              - 0.2947
                            - - 0.1781
                              - 0.2843
                            - - 0.1607
                              - 0.2218
                          base_xy: "{{ blues | random }}"
                          x_jitter: "{{ (range(-10,11) | random) / 1000 }}"
                          y_jitter: "{{ (range(-10,11) | random) / 1000 }}"
                          chosen_x: "{{ (base_xy[0] + x_jitter) | round(4) }}"
                          chosen_y: "{{ (base_xy[1] + y_jitter) | round(4) }}"
                          bright: "{{ range(20, 100) | random }}"
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color:
                            - "{{ chosen_x }}"
                            - "{{ chosen_y }}"
                          brightness: "{{ bright }}"
                          transition: "{{ range(3,7) | random }}"
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: "{{ range(200, 700) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'xmas_candlelight' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 40
                    xy_color:
                      - 0.433
                      - 0.399
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 120
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          base_xy:
                            - 0.433
                            - 0.399
                          x_jitter: "{{ (range(-6,7) | random) / 1000 }}"
                          y_jitter: "{{ (range(-6,7) | random) / 1000 }}"
                          chosen_x: "{{ (base_xy[0] + x_jitter) | round(4) }}"
                          chosen_y: "{{ (base_xy[1] + y_jitter) | round(4) }}"
                          bright: "{{ range(20, 120) | random }}"
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color:
                            - "{{ chosen_x }}"
                            - "{{ chosen_y }}"
                          brightness: "{{ bright }}"
                          transition: "{{ range(1,3) | random }}"
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: "{{ range(300, 800) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'xmas_gift_pulse' }}"
        sequence:
          - variables:
              gift_colors:
                - - 0.2138
                  - 0.7097
                - - 0.6389
                  - 0.3548
                - - 0.3227
                  - 0.329
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          base_xy: "{{ gift_colors | random }}"
                          x_jitter: "{{ (range(-10,11) | random) / 1000 }}"
                          y_jitter: "{{ (range(-10,11) | random) / 1000 }}"
                          chosen_x: "{{ (base_xy[0] + x_jitter) | round(4) }}"
                          chosen_y: "{{ (base_xy[1] + y_jitter) | round(4) }}"
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color:
                            - "{{ chosen_x }}"
                            - "{{ chosen_y }}"
                          brightness: 255
                          transition: 0.2
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: "{{ range(100, 400) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'nye_countdown' }}"
        sequence:
          - variables:
              flash_count: 10
          - repeat:
              count: "{{ flash_count }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          brightness: 255
                          xy_color:
                            - 0.3227
                            - 0.329
                          transition: 0
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: "{{ (200 - (repeat.index * 10)) | int }}"
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          brightness: 5
                          xy_color:
                            - 0.3127
                            - 0.329
                          transition: 0
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: 80
      - conditions:
          - condition: template
            value_template: "{{ effect == 'nye_confetti' }}"
        sequence:
          - variables:
              confetti_colors:
                - - 0.7006
                  - 0.2993
                - - 0.2138
                  - 0.7097
                - - 0.3645
                  - 0.1765
                - - 0.3227
                  - 0.329
                - - 0.5801
                  - 0.3959
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          base_xy: "{{ confetti_colors | random }}"
                          x_jitter: "{{ (range(-20,21) | random) / 1000 }}"
                          y_jitter: "{{ (range(-20,21) | random) / 1000 }}"
                          chosen_x: "{{ (base_xy[0] + x_jitter) | round(4) }}"
                          chosen_y: "{{ (base_xy[1] + y_jitter) | round(4) }}"
                          bright: "{{ range(200, 255) | random }}"
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color:
                            - "{{ chosen_x }}"
                            - "{{ chosen_y }}"
                          brightness: "{{ bright }}"
                          transition: 0
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: "{{ range(60, 200) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'nye_midnight_flash' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 255
                    xy_color:
                      - 0.3227
                      - 0.329
                    transition: 0
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 100
          - delay:
              seconds: 1
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 120
                    xy_color:
                      - 0.3227
                      - 0.329
                    transition: 4
                  continue_on_error: true
                  action: light.turn_on
      - conditions:
          - condition: template
            value_template: "{{ effect == 'nye_sparkler' }}"
        sequence:
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          base_xy:
                            - 0.3227
                            - 0.329
                          x_jitter: "{{ (range(-40,41) | random) / 1000 }}"
                          y_jitter: "{{ (range(-40,41) | random) / 1000 }}"
                          chosen_x: "{{ (base_xy[0] + x_jitter) | round(4) }}"
                          chosen_y: "{{ (base_xy[1] + y_jitter) | round(4) }}"
                          bright: "{{ range(180, 255) | random }}"
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color:
                            - "{{ chosen_x }}"
                            - "{{ chosen_y }}"
                          brightness: "{{ bright }}"
                          transition: 0
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: "{{ range(20, 120) | random }}"
      - conditions:
          - condition: template
            value_template: "{{ effect == 'nye_champagne' }}"
        sequence:
          - repeat:
              for_each: "{{ lights_list }}"
              sequence:
                - target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness: 40
                    xy_color:
                      - 0.433
                      - 0.399
                    transition: 1
                  continue_on_error: true
                  action: light.turn_on
                - delay:
                    milliseconds: 150
          - repeat:
              until:
                - condition: template
                  value_template: "{{ false }}"
              sequence:
                - repeat:
                    for_each: "{{ lights_list }}"
                    sequence:
                      - variables:
                          base_xy:
                            - 0.433
                            - 0.399
                          x_jitter: "{{ (range(-10,11) | random) / 1000 }}"
                          y_jitter: "{{ (range(-10,11) | random) / 1000 }}"
                          chosen_x: "{{ (base_xy[0] + x_jitter) | round(4) }}"
                          chosen_y: "{{ (base_xy[1] + y_jitter) | round(4) }}"
                          bright: "{{ range(30, 140) | random }}"
                      - target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          xy_color:
                            - "{{ chosen_x }}"
                            - "{{ chosen_y }}"
                          brightness: "{{ bright }}"
                          transition: "{{ range(2,6) | random }}"
                        continue_on_error: true
                        action: light.turn_on
                      - delay:
                          milliseconds: "{{ range(300, 900) | random }}"
